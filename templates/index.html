<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>A_Messager 2026</title>
    <style>
        /* –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–º */
        :root {
            --bg-color: #e5ddd5;
            --sidebar-bg: #ffffff;
            --header-bg: #075e54;
            --header-text: #ffffff;
            --friend-hover: #f5f5f5;
            --friend-active: #ebebeb;
            --chat-bg: #efeae2;
            --msg-other: #ffffff;
            --msg-me: #dcf8c6;
            --text-color: #333333;
            --border-color: #dddddd;
            --input-bg: #f0f0f0;
            --status-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-color: #0b141a;
            --sidebar-bg: #111b21;
            --header-bg: #202c33;
            --header-text: #e9edef;
            --friend-hover: #202c33;
            --friend-active: #2a3942;
            --chat-bg: #0b141a;
            --msg-other: #202c33;
            --msg-me: #005c4b;
            --text-color: #e9edef;
            --border-color: #313d45;
            --input-bg: #202c33;
            --status-bg: #111b21;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-color); overflow: hidden; color: var(--text-color); transition: background 0.3s; }

        .sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .sidebar-top { padding: 15px; border-bottom: 1px solid var(--border-color); background: var(--sidebar-bg); }
        .sidebar-top h4 { margin: 0 0 10px 0; color: var(--header-bg); font-size: 14px; }
        .add-form { display: flex; gap: 5px; }
        .add-form input { flex: 1; padding: 6px 10px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 13px; outline: none; }
        .add-form button { padding: 6px 12px; background: var(--header-bg); color: white; border: none; border-radius: 4px; cursor: pointer; }

        .friends-list { flex: 1; overflow-y: auto; }
        .friend-item { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-color); }
        .friend-item:hover { background: var(--friend-hover); }
        .friend-item.active { background: var(--friend-active); border-left: 5px solid #128c7e; }

        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border-color); background: var(--sidebar-bg); display: flex; align-items: center; justify-content: space-between; }
        .user-profile { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 35px; height: 35px; background: #128c7e; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); position: relative; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }

        .m { padding: 8px 12px; border-radius: 8px; max-width: 70%; box-shadow: 0 1px 1px rgba(0,0,0,0.1); background: var(--msg-other); align-self: flex-start; position: relative; color: var(--text-color); }
        .m.me { background: var(--msg-me); align-self: flex-end; padding-right: 25px; }
        .m img { max-width: 100%; border-radius: 6px; margin-top: 5px; display: block; cursor: pointer; }

        .del-btn { position: absolute; top: 4px; right: 6px; cursor: pointer; font-size: 16px; color: #aaa; display: none; }
        .m.me:hover .del-btn { display: block; }

        .encryption-notice { background: #fff9c4; font-size: 11px; text-align: center; padding: 6px; margin: 0 auto 15px; border-radius: 5px; border: 1px solid #fbc02d; color: #5d4037; width: fit-content; }
        .input-area { background: var(--input-bg); padding: 15px; display: flex; gap: 10px; align-items: center; }
        #msgInp { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--sidebar-bg); color: var(--text-color); outline: none; }
        .attach-btn { font-size: 24px; cursor: pointer; color: var(--text-color); }

        .status-panel { width: 220px; background: var(--status-bg); border-left: 1px solid var(--border-color); padding: 20px; text-align: center; display: none; }
        .online-tag { color: #25d366; font-weight: bold; }

        /* –ö–Ω–æ–ø–∫–∞ —Ç–µ–º—ã */
        .theme-toggle { cursor: pointer; font-size: 18px; padding: 5px; border-radius: 50%; transition: 0.3s; }
        .theme-toggle:hover { background: var(--friend-hover); }
    </style>
</head>
<body data-theme="light">
    <div class="sidebar">
        <div class="sidebar-top">
            <h4>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h4>
            <form action="/add_friend" method="POST" class="add-form">
                <input name="friend_username" placeholder="–≤–≤–µ–¥–∏—Ç–µ –∏–º—è –¥—Ä—É–≥–∞" required>
                <button type="submit">+</button>
            </form>
        </div>
        <div class="friends-list">
            {% for f in friends %}
                <div class="friend-item" onclick="openChat({{ f.id }}, this)">{{ f.username }}</div>
            {% endfor %}
        </div>
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">{{ username[0]|upper }}</div>
                <span style="font-weight: bold;">{{ username }}</span>
            </div>
            <div>
                <span class="theme-toggle" onclick="toggleTheme()" id="themeIcon">üåô</span>
                <a href="/logout" style="color:#d9534f; text-decoration:none; font-size:12px; font-weight:bold; margin-left:10px;">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <div class="chat-main" id="chat-window" style="display:none;">
        <div id="chat-box"></div>
        <div class="input-area">
            <label for="fileInp" class="attach-btn">üìé</label>
            <input type="file" id="fileInp" style="display:none;" onchange="uploadFile()">
            <input type="text" id="msgInp" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" style="border:none; background:none; cursor:pointer; font-size:22px; color:var(--header-bg)">‚û§</button>
        </div>
    </div>

    <div class="status-panel" id="status-panel">
        <div style="width:70px; height:70px; background:#ddd; border-radius:50%; margin:0 auto 15px; line-height:70px; font-size:30px; color:white;">üë§</div>
        <h3 id="stat-name"></h3>
        <div id="stat-status"></div>
    </div>

    <div id="no-chat-msg" style="flex:1; display:flex; justify-content:center; align-items:center; color:#888;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è, –ª–∏–±–æ –¥–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∞</div>

    <script>
        let currentFriendId = null;
        let lastCount = 0;

        // –õ–æ–≥–∏–∫–∞ —Ç–µ–º—ã
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').innerText = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', newTheme);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
        window.onload = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').innerText = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        };

        function openChat(id, el) {
            currentFriendId = id; lastCount = 0;
            document.getElementById('no-chat-msg').style.display = 'none';
            document.getElementById('chat-window').style.display = 'flex';
            document.getElementById('status-panel').style.display = 'block';
            document.querySelectorAll('.friend-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            load();
        }

        async function load() {
            if (!currentFriendId) return;
            const r = await fetch(`/api/messages/${currentFriendId}`);
            const data = await r.json();
            document.getElementById('stat-name').innerText = data.friend_name;
            document.getElementById('stat-status').innerHTML = data.online ? '<span class="online-tag">‚óè –í —Å–µ—Ç–∏</span>' : '–Ω–µ –≤ —Å–µ—Ç–∏';

            if (data.messages.length !== lastCount || lastCount === 0) {
                const box = document.getElementById('chat-box');
                let html = '<div class="encryption-notice">üîí –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã —Å–∫–≤–æ–∑–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º.</div>';
                data.messages.forEach(m => {
                    let content = m.text;
                    let delHtml = m.is_me ? `<span class="del-btn" onclick="deleteMsg(${m.id})">√ó</span>` : '';
                    if (m.text.startsWith('__file__:')) {
                        const parts = m.text.split(':');
                        const type = parts[1];
                        const url = parts.slice(2).join(':');
                        content = type === 'img' ? `<img src="${url}" onclick="window.open('${url}')">` : `<a href="${url}" target="_blank" style="color:#128c7e">üìÑ –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>`;
                    }
                    html += `<div class="m ${m.is_me ? 'me' : ''}">${delHtml}${content}<div style="font-size:9px; color:#999; text-align:right; margin-top:4px;">${m.time}</div></div>`;
                });
                box.innerHTML = html;
                box.scrollTop = box.scrollHeight;
                lastCount = data.messages.length;
            }
        }

        async function send() {
            const inp = document.getElementById('msgInp');
            if (!inp.value.trim()) return;
            const text = inp.value; inp.value = '';
            await fetch('/api/send', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ receiver_id: currentFriendId, text: text }) });
            load();
        }

        async function uploadFile() {
            const fileInp = document.getElementById('fileInp');
            if (!fileInp.files[0]) return;
            const formData = new FormData();
            formData.append('file', fileInp.files[0]);
            formData.append('receiver_id', currentFriendId);
            await fetch('/api/upload', { method: 'POST', body: formData });
            fileInp.value = '';
            load();
        }

        async function deleteMsg(id) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
            await fetch(`/api/delete_message/${id}`, { method: 'POST' });
            lastCount = -1; load();
        }

        setInterval(load, 2500);
    </script>
</body>
</html>
