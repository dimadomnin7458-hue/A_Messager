<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç: {{ room.name }}</title>
    <style>
        body { font-family: sans-serif; background: #e5ddd5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #075e54; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }

        /* –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .user-list { width: 120px; background: rgba(255,255,255,0.8); border-left: 1px solid #ccc; padding: 10px; font-size: 12px; }
        .user-online { color: green; margin-bottom: 5px; }

        .m { background: white; padding: 8px 12px; border-radius: 8px; max-width: 80%; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .encryption-notice { background: #fff9c4; font-size: 11px; text-align: center; padding: 5px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #fbc02d; color: #5d4037; }

        .input-area { background: #f0f0f0; padding: 15px; display: flex; gap: 10px; }
        #msgInp { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        .send-btn { background: #128c7e; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <strong>{{ room.name }} ({{ room.code }})</strong>
        <a href="/" style="color: white; text-decoration: none;">‚¨Ö –í—ã—Ö–æ–¥</a>
    </div>

    <div class="main-container">
        <div id="chat-box">
            <div class="encryption-notice">üîí –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã —Å–∫–≤–æ–∑–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º. –ù–∏–∫—Ç–æ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –∏—Ö –ø—Ä–æ—á–∏—Ç–∞—Ç—å.</div>
        </div>
        <div class="user-list" id="user-list">
            <b>–í —á–∞—Ç–µ:</b><div id="users-container"></div>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="msgInp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
        <button class="send-btn" onclick="send()">‚û§</button>
    </div>

    <script>
        const roomId = {{ room.id }};
        let lastCount = 0;

        async function load() {
            const r = await fetch(`/api/messages/${roomId}`);
            const data = await r.json();

            // –°–æ–æ–±—â–µ–Ω–∏—è
            if (data.messages.length !== lastCount) {
                const box = document.getElementById('chat-box');
                const notice = '<div class="encryption-notice">üîí –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã —Å–∫–≤–æ–∑–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º.</div>';
                box.innerHTML = notice + data.messages.map(m => `
                    <div class="m"><b>${m.username}</b> <small style="color:#999">${m.time}</small><br>${m.text}</div>
                `).join('');
                box.scrollTop = box.scrollHeight;
                lastCount = data.messages.length;
            }

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            document.getElementById('users-container').innerHTML = data.users.map(u => `
                <div class="user-online">‚óè ${u}</div>
            `).join('');
        }

        async function send() {
            const inp = document.getElementById('msgInp');
            if (!inp.value.trim()) return;
            const text = inp.value;
            inp.value = '';
            await fetch('/api/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room_id: roomId, text: text })
            });
            load();
        }
        setInterval(load, 2000);
        load();
    </script>
</body>
</html>
